rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Sounds collection
    match /sounds/{soundId} {
      // Anyone can read sounds
      allow read: if true;

      // Anyone can create sounds with basic validation
      allow create: if request.resource.data.keys().hasAll(['name', 'category', 'fileName'])
                       && request.resource.data.name is string
                       && request.resource.data.name.size() > 0
                       && request.resource.data.name.size() <= 100
                       && request.resource.data.category in ['classic', 'modern', 'futuristic', 'custom', 'funny', 'musical'];

      // Only allow updating likes and downloads fields (for like/download counters)
      allow update: if request.resource.data.diff(resource.data)
                       .affectedKeys().hasOnly(['likes', 'downloads']);

      // Only admins can delete sounds
      allow delete: if request.auth != null &&
                       exists(/databases/$(database)/documents/admins/$(request.auth.token.email));
    }

    // Admins collection - only readable by the admin themselves
    match /admins/{email} {
      // Admin can read their own document to verify admin status
      allow read: if request.auth != null &&
                     request.auth.token.email.lower() == email.lower();

      // No one can write to admins collection via client SDK
      // Admins should be added manually via Firebase Console
      allow write: if false;
    }

    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
